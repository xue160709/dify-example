# Dify API æµ‹è¯•å·¥å…·é›†

æœ¬é¡¹ç›®åŒ…å« Dify å¹³å°çš„å„ç§ API æµ‹è¯•è„šæœ¬ï¼Œæ–¹ä¾¿å¼€å‘è€…å¿«é€Ÿæ¥å…¥å’Œæµ‹è¯•ã€‚

## ğŸ“‹ æ–‡ä»¶è¯´æ˜

### çŸ¥è¯†åº“æ£€ç´¢ API
- **`test_simple.py`** - ç®€å•ç‰ˆçŸ¥è¯†åº“æ£€ç´¢æµ‹è¯•è„šæœ¬
- **`test_knowledge_retrieve.py`** - å®Œæ•´ç‰ˆçŸ¥è¯†åº“æ£€ç´¢æµ‹è¯•è„šæœ¬ï¼ŒåŒ…å«å¤šç§æ£€ç´¢æ¨¡å¼

### èŠå¤©æ¶ˆæ¯ API
- **`test_chat_simple.py`** - ç®€å•ç‰ˆèŠå¤©æ¶ˆæ¯æµ‹è¯•è„šæœ¬ï¼ˆæµå¼æ¨¡å¼ï¼‰
- **`test_chat_messages.py`** - å®Œæ•´ç‰ˆèŠå¤©æ¶ˆæ¯æµ‹è¯•è„šæœ¬ï¼ˆæ”¯æŒé˜»å¡å’Œæµå¼æ¨¡å¼ï¼‰

### å…¶ä»–
- **`requirements.txt`** - Pythonä¾èµ–åŒ…

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

### 2. è¿è¡ŒçŸ¥è¯†åº“æ£€ç´¢æµ‹è¯•

**ç®€å•æµ‹è¯•ï¼š**
```bash
python test_simple.py
```

**å®Œæ•´æµ‹è¯•ï¼š**
```bash
python test_knowledge_retrieve.py
```

### 3. è¿è¡ŒèŠå¤©æ¶ˆæ¯æµ‹è¯•

**ç®€å•æµ‹è¯•ï¼ˆé˜»å¡æ¨¡å¼ï¼‰ï¼š**
```bash
python test_chat_simple.py
```

**å®Œæ•´æµ‹è¯•ï¼ˆæ”¯æŒæµå¼å’Œé˜»å¡æ¨¡å¼ï¼‰ï¼š**
```bash
python test_chat_messages.py
```

## ğŸ“ é…ç½®ä¿¡æ¯

### çŸ¥è¯†åº“æ£€ç´¢ API
- **API Base URL**: `https://api.dify.ai/v1`
- **Dataset ID**: `ff09e8db-836d-4375-ae98-fa40228b967f`
- **API Key**: `xxx`

### èŠå¤©æ¶ˆæ¯ API
- **API Base URL**: `https://api.dify.ai/v1`
- **API Key**: `xxx`

## ğŸ¯ æµ‹è¯•ç”¨ä¾‹è¯´æ˜

## ä¸€ã€çŸ¥è¯†åº“æ£€ç´¢ API æµ‹è¯•

### æµ‹è¯• 1: åŸºæœ¬æœç´¢
æœ€ç®€å•çš„æ£€ç´¢æ–¹å¼ï¼Œåªéœ€è¦æä¾›æŸ¥è¯¢å­—ç¬¦ä¸²ã€‚

```python
retrieve_from_knowledge_base(query="ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½?")
```

### æµ‹è¯• 2: é«˜çº§æœç´¢ï¼ˆæ··åˆæœç´¢ + é‡æ’åºï¼‰
ä½¿ç”¨æ··åˆæœç´¢æ–¹æ³•ï¼Œç»“åˆé‡æ’åºæ¨¡å‹æå‡ç»“æœè´¨é‡ã€‚

```python
retrieval_config = {
    "search_method": "hybrid_search",
    "reranking_enable": True,
    "top_k": 5,
    "score_threshold": 0.5
}
```

### æµ‹è¯• 3: è¯­ä¹‰æœç´¢
åŸºäºè¯­ä¹‰ç†è§£çš„æœç´¢ï¼Œé€‚åˆç†è§£ç”¨æˆ·æ„å›¾ã€‚

```python
retrieval_config = {
    "search_method": "semantic_search",
    "top_k": 3
}
```

### æµ‹è¯• 4: å…¨æ–‡æœç´¢
åŸºäºå…³é”®è¯çš„å…¨æ–‡æ£€ç´¢ã€‚

```python
retrieval_config = {
    "search_method": "full_text_search",
    "top_k": 3
}
```

### æµ‹è¯• 5: å¸¦å…ƒæ•°æ®è¿‡æ»¤
æ ¹æ®å…ƒæ•°æ®æ¡ä»¶è¿‡æ»¤æ£€ç´¢ç»“æœã€‚

```python
retrieval_config = {
    "search_method": "hybrid_search",
    "metadata_filtering_conditions": {
        "logical_operator": "and",
        "conditions": [...]
    }
}
```

---

## äºŒã€èŠå¤©æ¶ˆæ¯ API æµ‹è¯•

### æµ‹è¯• 1: é˜»å¡æ¨¡å¼ - å•æ¬¡å¯¹è¯
æœ€ç®€å•çš„å¯¹è¯æ–¹å¼ï¼Œç­‰å¾…å®Œæ•´å“åº”åä¸€æ¬¡æ€§è¿”å›ã€‚

```python
send_chat_message_blocking(
    query="ä½ å¥½ï¼Œè¯·ç®€å•ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±"
)
```

**ç‰¹ç‚¹ï¼š**
- ç­‰å¾…å®Œæ•´å›å¤åè¿”å›
- å®ç°ç®€å•ï¼Œé€‚åˆå¯¹å®æ—¶æ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯
- è¿”å›å®Œæ•´çš„å“åº”æ•°æ®

### æµ‹è¯• 2: æµå¼æ¨¡å¼ - å•æ¬¡å¯¹è¯
ç±»ä¼¼æ‰“å­—æœºæ•ˆæœçš„æµå¼è¿”å›ï¼Œå®æ—¶æ˜¾ç¤º AI å›å¤ã€‚

```python
send_chat_message_streaming(
    query="è¯·ç”¨3å¥è¯ä»‹ç»ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½"
)
```

**ç‰¹ç‚¹ï¼š**
- å®æ—¶è¿”å›å›å¤å†…å®¹ï¼Œç”¨æˆ·ä½“éªŒæ›´å¥½
- åŸºäº SSEï¼ˆServer-Sent Eventsï¼‰å®ç°
- æ”¯æŒå®æ—¶æ˜¾ç¤ºå›å¤è¿›åº¦

**æµå¼äº‹ä»¶ç±»å‹ï¼š**
- `message` - LLM è¿”å›çš„æ–‡æœ¬å—
- `message_end` - æ¶ˆæ¯ç»“æŸäº‹ä»¶
- `message_file` - æ–‡ä»¶äº‹ä»¶
- `message_replace` - æ¶ˆæ¯å†…å®¹æ›¿æ¢äº‹ä»¶
- `workflow_started` - å·¥ä½œæµå¼€å§‹
- `node_started` - èŠ‚ç‚¹å¼€å§‹æ‰§è¡Œ
- `node_finished` - èŠ‚ç‚¹æ‰§è¡Œå®Œæˆ
- `workflow_finished` - å·¥ä½œæµå®Œæˆ
- `error` - é”™è¯¯äº‹ä»¶
- `ping` - ä¿æŒè¿æ¥çš„å¿ƒè·³äº‹ä»¶

### æµ‹è¯• 3: å¤šè½®å¯¹è¯
æ”¯æŒä¸Šä¸‹æ–‡çš„è¿ç»­å¯¹è¯ã€‚

```python
# ç¬¬ä¸€è½®å¯¹è¯
result1 = send_chat_message_blocking(
    query="æˆ‘æƒ³äº†è§£æœºå™¨å­¦ä¹ "
)

# ç¬¬äºŒè½®å¯¹è¯ï¼ˆä½¿ç”¨ç›¸åŒçš„ conversation_idï¼‰
result2 = send_chat_message_blocking(
    query="å®ƒæœ‰å“ªäº›åº”ç”¨åœºæ™¯ï¼Ÿ",
    conversation_id=result1.get('conversation_id')
)
```

**ç‰¹ç‚¹ï¼š**
- ä¿æŒå¯¹è¯ä¸Šä¸‹æ–‡
- é€šè¿‡ `conversation_id` å…³è”å¤šè½®å¯¹è¯
- AI èƒ½ç†è§£ä¹‹å‰çš„å¯¹è¯å†…å®¹

### æµ‹è¯• 4: å¸¦è¾“å…¥å˜é‡
ä¼ å…¥ App å®šä¹‰çš„å˜é‡å€¼ã€‚

```python
inputs = {
    "topic": "Pythonç¼–ç¨‹",
    "level": "åˆçº§"
}

send_chat_message_blocking(
    query="è¯·ä»‹ç»ä¸€ä¸‹ç›¸å…³å†…å®¹",
    inputs=inputs
)
```

### å“åº”æ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§ | é˜»å¡æ¨¡å¼ï¼ˆblockingï¼‰ | æµå¼æ¨¡å¼ï¼ˆstreamingï¼‰ |
|------|---------------------|---------------------|
| å“åº”æ–¹å¼ | ä¸€æ¬¡æ€§è¿”å›å®Œæ•´ç»“æœ | åˆ†å—å®æ—¶è¿”å› |
| ç”¨æˆ·ä½“éªŒ | éœ€è¦ç­‰å¾…å®Œæ•´å“åº” | æ‰“å­—æœºæ•ˆæœï¼Œå®æ—¶æ˜¾ç¤º |
| å®ç°å¤æ‚åº¦ | ç®€å• | éœ€è¦å¤„ç† SSE æµ |
| è¶…æ—¶é£é™© | é•¿æµç¨‹å¯èƒ½è¶…æ—¶ï¼ˆ100ç§’ï¼‰ | é€šè¿‡æµå¼ä¼ è¾“é¿å…è¶…æ—¶ |
| é€‚ç”¨åœºæ™¯ | çŸ­å¯¹è¯ã€æ‰¹é‡å¤„ç† | é•¿å¯¹è¯ã€éœ€è¦å®æ—¶åé¦ˆ |

### èŠå¤©æ¶ˆæ¯ API å“åº”æ•°æ®

**é˜»å¡æ¨¡å¼å“åº”ï¼š**
```json
{
    "event": "message",
    "task_id": "ä»»åŠ¡ID",
    "message_id": "æ¶ˆæ¯ID",
    "conversation_id": "ä¼šè¯ID",
    "mode": "chat",
    "answer": "AIçš„å®Œæ•´å›å¤",
    "metadata": {
        "usage": {
            "prompt_tokens": 1033,
            "completion_tokens": 128,
            "total_tokens": 1161,
            "total_price": "0.0012890",
            "currency": "USD"
        },
        "retriever_resources": [...]
    },
    "created_at": 1705407629
}
```

**æµå¼æ¨¡å¼å“åº”ï¼š**
æ¯ä¸ªäº‹ä»¶ä»¥ `data:` å¼€å¤´ï¼Œäº‹ä»¶ä¹‹é—´ç”¨ä¸¤ä¸ªæ¢è¡Œç¬¦åˆ†éš”ï¼š
```
data: {"event": "message", "answer": "Hi", ...}

data: {"event": "message_end", "metadata": {...}}
```

---

## ğŸ”§ è‡ªå®šä¹‰æŸ¥è¯¢

### çŸ¥è¯†åº“æ£€ç´¢ - ä¿®æ”¹æŸ¥è¯¢å†…å®¹

åœ¨ `test_simple.py` ä¸­ä¿®æ”¹è¿™ä¸€è¡Œï¼š

```python
payload = {
    "query": "ä½ çš„æŸ¥è¯¢å†…å®¹"  # ä¿®æ”¹è¿™é‡Œ
}
```

### èŠå¤©æ¶ˆæ¯ - ä¿®æ”¹å¯¹è¯å†…å®¹

åœ¨ `test_chat_simple.py` ä¸­ä¿®æ”¹è¿™ä¸€è¡Œï¼š

```python
payload = {
    "query": "ä½ æƒ³è¯´çš„è¯",  # ä¿®æ”¹è¿™é‡Œ
    "response_mode": "blocking",  # æˆ– "streaming"
    "user": "your-user-id"
}
```

### è°ƒæ•´æ£€ç´¢å‚æ•°

åœ¨ `test_knowledge_retrieve.py` ä¸­å¯ä»¥è‡ªå®šä¹‰ä»¥ä¸‹å‚æ•°ï¼š

- **`search_method`**: æœç´¢æ–¹æ³•
  - `hybrid_search` - æ··åˆæœç´¢
  - `semantic_search` - è¯­ä¹‰æœç´¢
  - `full_text_search` - å…¨æ–‡æœç´¢
  - `keyword_search` - å…³é”®è¯æœç´¢

- **`top_k`**: è¿”å›ç»“æœæ•°é‡ï¼ˆé»˜è®¤ï¼š3ï¼‰

- **`score_threshold`**: æœ€ä½ç›¸å…³åº¦åˆ†æ•°ï¼ˆ0-1ä¹‹é—´ï¼‰

- **`reranking_enable`**: æ˜¯å¦å¯ç”¨é‡æ’åº

- **`weights`**: æ··åˆæœç´¢ä¸­è¯­ä¹‰æœç´¢çš„æƒé‡ï¼ˆ0-1ä¹‹é—´ï¼‰

## ğŸ“Š å“åº”ç»“æœè¯´æ˜

API è¿”å›çš„æ¯ä¸ªç»“æœåŒ…å«ï¼š

- **`score`**: ç›¸å…³åº¦åˆ†æ•°ï¼ˆè¶Šé«˜è¶Šç›¸å…³ï¼‰
- **`segment`**: æ®µè½ä¿¡æ¯
  - `id`: æ®µè½ID
  - `content`: æ®µè½å†…å®¹
  - `word_count`: å­—æ•°
  - `tokens`: Tokenæ•°é‡
  - `keywords`: å…³é”®è¯åˆ—è¡¨
  - `document`: æ–‡æ¡£ä¿¡æ¯
    - `name`: æ–‡æ¡£åç§°
    - `data_source_type`: æ•°æ®æºç±»å‹

## â— å¸¸è§é—®é¢˜

### çŸ¥è¯†åº“æ£€ç´¢ API

#### 1. 401 Unauthorized
æ£€æŸ¥ Dataset API Key æ˜¯å¦æ­£ç¡®ã€‚

#### 2. 404 Not Found
æ£€æŸ¥ Dataset ID æ˜¯å¦æ­£ç¡®ã€‚

#### 3. è¿”å›ç»“æœä¸ºç©º
- çŸ¥è¯†åº“å¯èƒ½æ²¡æœ‰ç›¸å…³å†…å®¹
- å°è¯•è°ƒæ•´ `score_threshold` é˜ˆå€¼
- å°è¯•ä¸åŒçš„æœç´¢æ–¹æ³•

### èŠå¤©æ¶ˆæ¯ API

#### 1. 400 invalid_param
- æ£€æŸ¥è¯·æ±‚å‚æ•°æ˜¯å¦æ­£ç¡®
- ç¡®è®¤ `response_mode` æ˜¯ "blocking" æˆ– "streaming"

#### 2. 400 app_unavailable
- App é…ç½®ä¸å¯ç”¨
- æ£€æŸ¥ App æ˜¯å¦å·²å‘å¸ƒ

#### 3. 400 provider_not_initialize
- æ— å¯ç”¨æ¨¡å‹å‡­æ®é…ç½®
- åœ¨ Dify æ§åˆ¶å°é…ç½®æ¨¡å‹

#### 4. 400 provider_quota_exceeded
- æ¨¡å‹è°ƒç”¨é¢åº¦ä¸è¶³
- æ£€æŸ¥è´¦æˆ·é¢åº¦

#### 5. 400 conversation_id_not_exist
- ä¼šè¯ ID ä¸å­˜åœ¨
- æ£€æŸ¥ conversation_id æ˜¯å¦æ­£ç¡®

#### 6. æµå¼æ¨¡å¼æ¥æ”¶ä¸å®Œæ•´
- ç¡®ä¿æ­£ç¡®å¤„ç† SSE æµ
- æ£€æŸ¥ç½‘ç»œè¿æ¥ç¨³å®šæ€§

### é€šç”¨é—®é¢˜

#### 1. è¿æ¥è¶…æ—¶
- æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œç¡®ä¿å¯ä»¥è®¿é—® `api.dify.ai`
- æµå¼æ¨¡å¼å¯ä»¥é¿å…é•¿è¯·æ±‚è¶…æ—¶é—®é¢˜

#### 2. å­—ç¬¦ç¼–ç é—®é¢˜
- ç¡®ä¿ä½¿ç”¨ UTF-8 ç¼–ç 
- æ­£ç¡®å¤„ç†ä¸­æ–‡å­—ç¬¦

## ğŸ’¡ ä½¿ç”¨å»ºè®®

### çŸ¥è¯†åº“æ£€ç´¢ API
1. **å¿«é€Ÿæµ‹è¯•**: ä½¿ç”¨ `test_simple.py`
2. **è¯¦ç»†è°ƒè¯•**: ä½¿ç”¨ `test_knowledge_retrieve.py`
3. **æ€§èƒ½ä¼˜åŒ–**: æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´ `top_k` å’Œ `score_threshold`

### èŠå¤©æ¶ˆæ¯ API
1. **å¿«é€Ÿæµ‹è¯•**: ä½¿ç”¨ `test_chat_simple.py`ï¼ˆé˜»å¡æ¨¡å¼ï¼‰
2. **è¯¦ç»†è°ƒè¯•**: ä½¿ç”¨ `test_chat_messages.py`ï¼ˆæ”¯æŒæµå¼å’Œé˜»å¡ï¼‰
3. **ç”Ÿäº§æ¨è**: ä¼˜å…ˆä½¿ç”¨æµå¼æ¨¡å¼ï¼Œç”¨æˆ·ä½“éªŒæ›´å¥½
4. **å¤šè½®å¯¹è¯**: ä¿å­˜å¹¶å¤ç”¨ `conversation_id`
5. **é”™è¯¯å¤„ç†**: æ•è·å¹¶å¤„ç†å„ç§ event ç±»å‹ï¼Œç‰¹åˆ«æ˜¯ `error` äº‹ä»¶

### é€šç”¨å»ºè®®
1. **å®‰å…¨æ€§**: å°† API Key å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡ä¸­ï¼Œä¸è¦ç¡¬ç¼–ç 
2. **é”™è¯¯å¤„ç†**: æ·»åŠ é€‚å½“çš„å¼‚å¸¸å¤„ç†å’Œé‡è¯•æœºåˆ¶
3. **æ—¥å¿—è®°å½•**: è®°å½•å…³é”®æ“ä½œå’Œé”™è¯¯ä¿¡æ¯
4. **æˆæœ¬æ§åˆ¶**: æ³¨æ„ token ä½¿ç”¨é‡å’Œè´¹ç”¨

## ğŸ”’ å®‰å…¨æç¤º

âš ï¸ **é‡è¦**: ä¸è¦å°†API Keyæäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿä¸­ï¼

å»ºè®®ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼š

```python
import os
API_KEY = os.getenv('DIFY_API_KEY')
```

ç„¶ååœ¨å‘½ä»¤è¡Œä¸­è®¾ç½®ï¼š

```bash
# Windows PowerShell
$env:DIFY_API_KEY="your-api-key"

# Windows CMD
set DIFY_API_KEY=your-api-key

# Linux/Mac
export DIFY_API_KEY=your-api-key
```

